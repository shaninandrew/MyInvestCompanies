@page "/"

@using MyInvestCompanies;
@using MyInvestCompanies.модель_данных;

@code 
{
    [Parameter]
    public string query_string  { get; set;} = "";

    public string Company_id    { get; set ; } = "";

}


@{
    void ShowRowEditor_company(Company c)
    {
        
        List<string> NameX = new List<string>();
        NameX.Add("Name");
        <!--  @onmouseover="(e=> { Company_id = c.Id; } -->
        <div class="Editor">

            <input type="text" value="@c.Name" @onfocus="(e=> { Company_id = c.Id; })" @onclick="(e=> { Company_id = c.Id; })" @onchange="(e=>  { Set_value(NameX[0], c.Id.ToString(), e.Value.ToString() , e, null);  })" />
            
             @{
                 NameX.Add("Founded");
                 string tmp_date = c.Founded.Date.ToUniversalTime().ToString("yyyy-MM-dd");
                }

                <input type=date value="@tmp_date"          @onfocus="(e=> { Company_id = c.Id; })" @onclick="(e=> { Company_id = c.Id; })" @onchange="(e=> {  Set_value(NameX[1], c.Id.ToString(), e.Value.ToString() , e,null);  })" />
            @{NameX.Add("Address");}
            <input type="text" value="@c.Address" @onfocus="(e=> { Company_id = c.Id; })" @onclick="(e=> { Company_id = c.Id; })" @onchange="(e=> {  Set_value(NameX[2], c.Id.ToString(), e.Value.ToString() , e, null );  })" />
            @{NameX.Add("Fact_Address"); }
            <input type="text" value="@c.Fact_Address" @onfocus="(e=> { Company_id = c.Id; })" @onclick="(e=> { Company_id = c.Id; })" @onchange="(e=> {  Set_value(NameX[3], c.Id.ToString(), e.Value.ToString() , e, null);  })" />
            @{NameX.Add("Description"); }
            <input type="text" value="@c.Description" @onfocus="(e=> { Company_id = c.Id; })" @onclick="(e=> { Company_id = c.Id; })" @onchange="(e=> {  Set_value(NameX[4], c.Id.ToString(), e.Value.ToString() , e, null);  })" />
            @{NameX.Add("Inn"); }
            <input type="number" value="@c.Inn" @onfocus="(e=> { Company_id = c.Id; })" @onclick="(e=> { Company_id = c.Id; })" @onchange="(e=> {  Set_value(NameX[5], c.Id.ToString(), e.Value.ToString() , e, null);  })" />
            @{NameX.Add("KPP"); }
            <input type="number" value="@c.KPP" @onfocus="(e=> { Company_id = c.Id; })" @onclick="(e=> { Company_id = c.Id; })" @onchange="(e=> {  Set_value(NameX[6], c.Id.ToString(), e.Value.ToString() , e, null );  })" />
             <button title="Удалить запись @c.Name @c.Address" @onclick="(e=> {Delete_company(c.Id.ToString(), null) ;} )">-</button>
        </div>
    }


    void Show_Linx (string company_id)
    {
        Database_structure ds = new Database_structure();
        string id = company_id;
        //спиоск связей
        List<Link> links =  ds.Links.Where<Link>(L => L.Parent_Id == id).ToList<Link>();

        <div>
            @foreach (Link l in links)
            {
                @l.Child_Id @l.Child_table<br />

            }
        </div>

        ds.Dispose();
    }

    /// Показ любой таблицы
    void Show_Table (string company_id, string table_name)
    {
        Database_structure ds = new Database_structure();
        string id = company_id;
        //спиоск связей
        List<Link> links = ds.Links.Where<Link>(L => L.Parent_Id == id).ToList<Link>();

        <div>
            @foreach (Link l in links)
            {
                @l.Child_Id @l.Child_table

                <br />

            }
        </div>

        if (table_name == "Capitals")
        {
            List<Capital> list_of_capital =  ds.Capitals.Where<Capital>(C => C.Id_company == company_id).ToList<Capital>();
            
            <div class="Control">
                <input type="button" value="Добавить капитал" />
            </div>

            <div>
                @foreach (Capital c in list_of_capital)
                {
                    @c.Sum  @c.Date

                    <br />

                }
            </div>
        }


        ds.Dispose();
    }


   // --- Загрузка  данных ---
    Database_structure db_index = new Database_structure();
    List<Company> list_of_companies = null;
    Console.Write("Отображение редактора ...");

    if ((query_string != "") && (query_string.Length > 0)  )
    {
        list_of_companies = new List<Company>();
        list_of_companies.Clear();

        foreach (Company c in db_index.Companies.ToList<Company>())
        {
            string t = c.Inn + c.Name + c.Address + c.KPP + c.Description + c.Fact_Address;
            if (t.IndexOf(query_string, StringComparison.OrdinalIgnoreCase) > -1)
            {
                list_of_companies.Add(c);
            }
        }
    }
    else
    {
        list_of_companies = db_index.Companies.ToList<Company>(  );
    }

    Comparison<Company> x_comp = new Comparison<Company>(delegate( Company x, Company y) { return (x.Id.CompareTo(y.Id)); });

    list_of_companies.Sort(x_comp);
    db_index.Dispose();



}

<div class="Search">
Поиск компаний  <input class="search_string" title="Поисковая строка" type="text" @bind-value=query_string @bind-value:event="oninput" />
</div>


<div class="Control">
<!--- делаем через лябмду - иначе кнопка запускается автоматом -->
<button  @onclick="(e)=>{  Add_company(null); }">Добавить компанию </button> 
 Тестовая инфа: @Company_id
<br/> 
</div>

<div class="scroll">
    <div style="height:300px;  background:#00000068 ; ">
        <!-- вывод списка -->
        
        @foreach (Company c in list_of_companies)
                {
                   ShowRowEditor_company(c); 
                }
        @{ Console.WriteLine("Оk ..."); }

        
    </div>
</div>

<div>
 <div class="Control"> Связанные таблицы</div>
 <div>
        @if (Company_id != null)
        {
            Show_Linx(Company_id);
        }

 </div>

    @Show_Table(Company_id,"Capitals");


</div>



@code{
    static public EventCallback Delete_company(string id, Database_structure? dbx)
    {

        Database_structure db = null;

        if (dbx != null)
            { db = dbx; }
        else
            { db = new Database_structure(); }
        try
        {
            Company c = db.Companies.Where<Company>(i => i.Id == id).Single<Company>();
            Console.Write($"Удаляем запись {c.Name} {c.Id}");
            db.Companies.Remove(c);
            db.SaveChanges();
            Console.WriteLine($" успешно...");
        }
        catch (Exception ex)
        {
            
         Console.WriteLine($"Удаление id= {id} " + ex.Message        );
        }

        //чистим память если автономно
        if (dbx == null)
            { db.Dispose(); }


        return (new EventCallback());
    }

    static public EventCallback Add_company(Database_structure? dbx)
    {

        Database_structure db = null;

        if (dbx != null)
            { db = dbx; }
        else
            { db = new Database_structure(); }


        Company c = new Company();
        c.Name = "???";
        db.Companies.Add(c);
        db.SaveChanges();

        //чистим память если автономно
        if (dbx == null)
        { db.Dispose(); }

        return (new EventCallback());

    }

    static public  EventCallback Set_value(string name, string id, string value, ChangeEventArgs? e, Database_structure? dbx)// (object sender, ChangeEventArgs e)//(string name, string id)
    {

        Database_structure db = null;

        if (dbx != null)
            { db = dbx; }
        else
            { db = new Database_structure(); }

        Console.WriteLine($"Установка значения {name} id={id}: {value}");

        var t= db.Companies.Where<Company>(i => i.Id == id).Single<Company>();

        Console.WriteLine($"Установка значения - {t.Id} {t.Name}: {t.Description} {t.KPP} {t.Address} {t.Fact_Address} {t.Founded} {t.Inn}");

        try
        {
            if (name == "Name")
                { t.Name = e.Value.ToString(); }
            if (name == "Founded")
                { t.Founded = DateTime.Parse(e.Value.ToString()).ToUniversalTime(); }
            if (name == "Address")
                { t.Address = e.Value.ToString(); }
            if (name == "Fact_Address")
                { t.Fact_Address = e.Value.ToString(); }
            if (name == "Description")
                { t.Description = e.Value.ToString(); }
            if (name == "Inn")
                { t.Inn = e.Value.ToString(); }
            if (name == "KPP")
                { t.KPP = e.Value.ToString(); }

            db.Update<Company>(t);
            db.SaveChanges();
            

        } catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            Console.WriteLine(ex.InnerException.Message);
        }
        
        //чистим память если автономно
        if (dbx == null)
        { db.Dispose(); }
        EventCallback evc = new EventCallback();
        return (evc);
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        


}
